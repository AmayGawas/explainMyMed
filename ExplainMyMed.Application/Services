using System.Text;
using System.Text.Json;
using System.Net.Http.Headers;

public class OpenAiMedicineService
{
    private readonly HttpClient _http;
    private readonly string _apiKey;

    public OpenAiMedicineService(HttpClient http, IConfiguration config)
    {
        _http = http;
        _apiKey = config["OpenAI:ApiKey"];
    }

    public async Task<MedicineInfoDto> GetMedicineInfo(string medName)
    {
        var prompt = $"""
You are a medical assistant. 
Return ONLY valid JSON.
For medicine: {medName}

Fields:
manufacturer,
usedFor,
dosage,
commonSideEffect,
isSideEffectCommon,
severeReactions,
isSuitableForPregnantWomen,
isSuitableForKidneyProblem,
isAllergyInducing,
isSafeWithAlcohol,
isSteroidal,
isSafeWithBPMed,
sourceOfInfo
""";

        var body = new
        {
            model = "gpt-4.1-mini",
            messages = new[]
            {
                new { role = "user", content = prompt }
            },
            temperature = 0.2
        };

        var request = new HttpRequestMessage(HttpMethod.Post, "https://api.openai.com/v1/chat/completions");
        request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", _apiKey);
        request.Content = new StringContent(JsonSerializer.Serialize(body), Encoding.UTF8, "application/json");

        var response = await _http.SendAsync(request);
        response.EnsureSuccessStatusCode();

        var json = await response.Content.ReadAsStringAsync();

        var content = JsonDocument.Parse(json)
            .RootElement
            .GetProperty("choices")[0]
            .GetProperty("message")
            .GetProperty("content")
            .GetString();

        return JsonSerializer.Deserialize<MedicineInfoDto>(content);
    }
}